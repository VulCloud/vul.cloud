{# Initialize variables #}
{%- if config.extra.nav.icon %}
	{%- if config.extra.nav.icon != true %}
		{%- if config.extra.nav.icon is matching("^https?://") %}
			{%- set nav_icon = config.extra.nav.icon | safe %}
		{%- else %}
			{%- set nav_icon = get_url(path=config.extra.nav.icon) %}
		{%- endif -%}
	{%- elif config.extra.fediverse.host and config.extra.fediverse.user %}
		{%- set webfinger_url = "https://" ~ config.extra.fediverse.host ~ "/.well-known/webfinger?resource=acct:" ~ config.extra.fediverse.user ~ "@" ~ config.extra.fediverse.host %}
		{%- set webfinger_json = load_data(url=webfinger_url, format="json", required=false) %}
		{%- for link in webfinger_json.links %}
			{%- if link.rel == "http://webfinger.net/rel/avatar" %}
				{%- set_global nav_icon = link.href %}
				{%- break %}
			{%- endif %}
		{%- endfor %}
	{%- elif config.extra.nav.icon == true and config.extra.meta.apple_touch_icon %}
		{%- if config.extra.meta.apple_touch_icon != true %}
			{%- set nav_icon = get_url(path=config.extra.meta.apple_touch_icon) %}
		{%- else %}
			{%- set nav_icon = get_url(path="apple-touch-icon.png") %}
		{%- endif %}
	{%- endif %}
{%- endif %}

{%- if config.extra.home_url -%}
	{%- set home_url = get_url(path=config.extra.home_url, lang=lang) -%}
{%- else -%}
	{%- set home_url = get_url(path="@/_index.md", lang=lang) -%}
{%- endif -%}

{%- if current_url | default(value="/") == home_url -%}
	{%- set home_active = true -%}
	{%- set after_active = true -%}
{%- endif -%}

{%- if not home_active -%}
	{%- set home_url = home_url ~ "#up" -%}
{%- endif -%}

{# Nav itself #}
<div id="site-nav">
	<a id="nav-header" {% if nav_icon %}class="has-icon"{% endif %} href="#top">
		{%- if nav_icon -%}
			<img width="36" height="36" class="transparent no-hover" src="{{ nav_icon }}" alt="" />
		{%- else -%}
			{{- macros_icon::icon(name="arrow-line-up") -}}
		{%- endif -%}
		<div>
			<span>
				{%- if current_path and current_path == "/" -%}
					{%- set title = config.title -%}
				{% elif title %}
					{%- set title = title -%}
				{% elif section.title -%}
					{%- set title = section.title -%}
				{% elif page.title %}
					{%- set title = page.title -%}
				{% elif term.name %}
					{%- set title = term.name -%}
				{% elif taxonomy.name %}
					{%- set title = taxonomy.name | capitalize -%}
				{% else %}
					{%- set title = "404" %}
				{%- endif -%}

				{{- title -}}
			</span>
			<span>{{ macros_translate::translate(key="back_to_top", default="Back to Top", language_strings=language_strings) }}</span>
		</div>
	</a>
		
	<nav class="overshoot">
		<ul>
			{%- if lang != config.default_language -%}
				{%- set nav_links = config.extra.nav[lang].links -%}
			{%- else -%}
				{%- set nav_links = config.extra.nav.links -%}
			{%- endif -%}

			<li>
				<a href="{{ home_url }}" {% if home_active %}aria-current="page"{% endif %}>
					{{- macros_icon::icon(name="house") -}}
					{{- config.title -}}
				</a>
			</li>
			{%- for link in nav_links -%}
				{%- if link.category and link.category | length > 0 -%}
					<li>
						<details {% if not link.closed %}open{% endif %}>
							<summary>
								{{- link.name -}}
								<div class="line"></div>
							</summary>
							<ul>
								{%- for link in link.category -%}
									{# Link URL #}
									{%- set link_external = false -%}

									{%- if link.url is matching("^https?://") -%}
										{%- set link_url = link.url -%}
										{%- set link_external = true -%}
									{%- else -%}
										{%- set link_url = get_url(path=link.url, lang=lang) -%}
									{%- endif -%}

									{# Active link #}
									{%- set link_active = false -%}

									{%- if not link_external and current_url | default(value="/") | trim_end_matches(pat='/') | safe == link_url | trim_end_matches(pat='/') | safe -%}
										{%- set link_active = true -%}
									{%- endif -%}

									{{ macros_link::link(
										link=link,
										lang=lang,
										link_url=link_url,
										link_external=link_external,
										link_active=link_active,
										after_active=after_active | default(value=false)) }}

									{%- if link_active -%}
										{%- set_global after_active = true -%}
									{%- endif -%}
								{%- endfor -%}
							</ul>
						</details>
					</li>
				{%- else -%}
					{# Link URL #}
					{%- set link_external = false -%}

					{%- if link.url is matching("^https?://") -%}
						{%- set link_url = link.url -%}
						{%- set link_external = true -%}
					{%- else -%}
						{%- set link_url = get_url(path=link.url, lang=lang) -%}
					{%- endif -%}

					{# Active link #}
					{%- set link_active = false -%}

					{%- if not link_external and current_url | default(value="/") | trim_end_matches(pat='/') | safe == link_url | trim_end_matches(pat='/') | safe -%}
						{%- set link_active = true -%}
					{%- endif -%}

					{{ macros_link::link(
						link=link,
						lang=lang,
						link_url=link_url,
						link_external=link_external,
						link_active=link_active,
						after_active=after_active | default(value=false)) }}

					{%- if link_active -%}
						{%- set_global after_active = true -%}
					{%- endif -%}
				{%- endif -%}
			{%- endfor -%}
		</ul>
	</nav>

	<ul id="nav-buttons">
		<li>
			<input class="visually-hidden" id="expand-sidebar" type="checkbox" name="expand-sidebar" autocomplete="off" />
			<label for="expand-sidebar" title="{{ macros_translate::translate(key='toggle_nav', default='Toggle Sidebar', language_strings=language_strings) }}">
				{{- macros_icon::icon(name="sidebar") -}}
			</label>
		</li>
		{%- if config.generate_feeds or section.generate_feeds or (taxonomy.feed and term.path) -%}
			<li>
				<details class="closable">
					<summary title="{{ macros_translate::translate(key='feed', default='Feed', language_strings=language_strings) }}">
						{{- macros_icon::icon(name="rss-simple") -}}
					</summary>
					<ul class="dropdown">
						{%- for feed_filename in config.feed_filenames -%}
							{%- if section.generate_feeds -%}
								{%- set feed_filename = current_path ~ feed_filename -%}
							{%- endif -%}
							{%- if taxonomy.feed and term.path -%}
								{%- set feed_filename = term.path ~ feed_filename -%}
							{%- endif -%}
							<a href="{{ get_url(path=feed_filename, lang=lang) }}">
								{%- if feed_filename is containing("atom") -%}
									Atom
								{%- elif feed_filename is containing("rss") -%}
									RSS
								{%- else -%}
									{{ macros_translate::translate(key="feed", default="Feed", language_strings=language_strings) }}
								{%- endif -%}
							</a>
						{%- endfor -%}
					</ul>
				</details>
			</li>
		{%- endif %}
		{%- if config.build_search_index -%}
			<li>
				<button id="search" title="{{ macros_translate::translate(key='search', default='Search', language_strings=language_strings) }}">
					{{- macros_icon::icon(name="magnifying-glass") -}}
				</button>
			</li>
		{%- endif -%}
		{%- if config.languages | length > 0 -%}
			<li>
				<details class="closable">
					<summary title="{{ macros_translate::translate(key='change_language', default='Change Language', language_strings=language_strings) }}">
						{{- macros_icon::icon(name="translate") -}}
					</summary>
					{%- include "partials/language_switcher.html" -%}
				</details>
			</li>
		{%- endif -%}
	</ul>
</div>
